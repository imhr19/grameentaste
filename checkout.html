<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout | Grameen Taste</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #fffaf0;
      color: #4b3621;
      padding: 20px;
    }
    h1 {
      color: #2e7d32;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fffaf0;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #c7a17a;
    }
    button {
      background-color: #207c26;
      color: white;
      padding: 12px;
      border: none;
      width: 100%;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background-color: #388e3c;
    }
    .cart-summary {
      margin-top: 20px;
      background: #ffe8d6;
      padding: 10px;
      border-radius: 8px;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Place Your Order</h1>
    <form id="checkoutForm">
      <input type="text" id="name" placeholder="Your Name" required />
      <input type="tel" id="phone" placeholder="Phone Number" required />
      <textarea id="address" placeholder="Full Address" required></textarea>
      <div class="cart-summary" id="cartSummary"></div>
      <button type="submit">Place Order</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBCj71-HO8i_xpgQ-Wbn5j85V9yHeJKdOg", // replace with your actual key
      authDomain: "grameentaste-929dc.firebaseapp.com",
      databaseURL: "https://grameentaste-929dc-default-rtdb.firebaseio.com",
      projectId: "grameentaste-929dc",
      storageBucket: "grameentaste-929dc.appspot.com",
      messagingSenderId: "***********",
      appId: "1:***********:web:************"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const buyNowCart = JSON.parse(localStorage.getItem("buyNowCart"));
    const regularCart = JSON.parse(localStorage.getItem("cart")) || [];
    
    // Prioritize buyNowCart if it exists, otherwise use the regular cart
    const cart = buyNowCart || regularCart;

    const cartSummary = document.getElementById("cartSummary");
    let total = 0;
    cart.forEach(item => {
      total += item.price * item.quantity;
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `<span>${item.name} x ${item.quantity}</span><span>₹${item.price * item.quantity}</span>`;
      cartSummary.appendChild(div);
    });
    if (cart.length > 0) {
      const totalDiv = document.createElement("div");
      totalDiv.className = "cart-item";
      totalDiv.style.fontWeight = "bold";
      totalDiv.innerHTML = `<span>Total</span><span>₹${total}</span>`;
      cartSummary.appendChild(totalDiv);
    }

    document.getElementById("checkoutForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const order = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        cart: cart,
        total: total,
        timestamp: new Date().toISOString()
      };
      push(ref(db, "orders"), order).then((refResult) => {
          const orderId = refResult.key;
          localStorage.setItem("lastOrderId", orderId);
          localStorage.setItem("lastOrderData", JSON.stringify(order));

          // Manage cart state based on the type of checkout
          if (buyNowCart) {
              // This was a "Buy Now" order. Remove the ordered item from the main cart.
              localStorage.removeItem("buyNowCart"); // Clean up the temporary cart
              
              const mainCart = JSON.parse(localStorage.getItem("cart") || "[]");
              if (mainCart.length > 0) {
                  const orderedItemId = buyNowCart[0].id; // The ID of the item just ordered
                  // Filter the main cart to remove the item that was purchased
                  const updatedMainCart = mainCart.filter(item => item.id !== orderedItemId);
                  localStorage.setItem("cart", JSON.stringify(updatedMainCart));
              }

          } else {
              // This was a regular checkout from the main cart. Clear it entirely.
              localStorage.removeItem("cart");
          }
          
          window.location.href = "/thanks.html";
      });
    });
  </script>
</body>
</html>