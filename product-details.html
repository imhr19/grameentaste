<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Grameen Taste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      :root {
        --primary: #6B8E23;
        --secondary: #DAA520;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #F5F5DC;
      }
      .image-gallery-container {
        position: relative;
      }
      .main-image-container {
        position: relative;
        cursor: crosshair;
      }
      .magnifier-lens {
        position: absolute;
        border: 2px solid var(--primary);
        background-color: rgba(255, 255, 255, 0.2); /* Makes lens slightly visible */
        width: 150px; /* Adjust lens size as needed */
        height: 150px;
        pointer-events: none;
        display: none;
        z-index: 10;
      }
      .magnified-result {
        position: absolute;
        top: 0;
        left: 102%; /* Position it to the right of the gallery */
        width: 100%;
        height: 100%;
        border: 1px solid #ddd;
        background-repeat: no-repeat;
        z-index: 20;
        pointer-events: none;
        display: none;
        background-color: white;
      }
      .thumbnail-list img.active-thumbnail {
        border: 2px solid var(--primary);
        box-shadow: 0 0 8px rgba(107, 142, 35, 0.7);
        transform: scale(1.05);
      }
      .scroll-container {
        scrollbar-width: thin;
        scrollbar-color: var(--primary) #e0e0e0;
      }
      .scroll-container::-webkit-scrollbar { height: 8px; }
      .scroll-container::-webkit-scrollbar-track { background: #e0e0e0; border-radius: 10px; }
      .scroll-container::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 10px; border: 2px solid #e0e0e0; }
      .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
      
      @media (max-width: 1023px) {
        .magnifier-lens, .magnified-result {
            display: none !important;
        }
      }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, RecaptchaVerifier, signInWithPhoneNumber, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
      
        const firebaseConfig = {
          apiKey: "AIzaSyBCj71-HO8i_xpgQ-Wbn5j85V9yHeJKdOg",
          authDomain: "grameentaste-929dc.firebaseapp.com",
          projectId: "grameentaste-929dc",
          storageBucket: "grameentaste-929dc.firebasestorage.app",
          messagingSenderId: "472094939233",
          appId: "1:472094939233:web:a5e8f2877e8b9318c83220",
          measurementId: "G-WLHK4FD1D5"
        };
      
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        window.auth = auth;
    
        // --- CONSOLIDATED DOM ELEMENT REFERENCES ---
        const loginDrawer = document.getElementById("login-drawer");
        const loginOverlay = document.getElementById("login-overlay");
        const loginOpenBtn = document.getElementById("user-btn");
        const loginCloseBtn = document.getElementById("close-login-drawer");
        const profileDrawer = document.getElementById("profileDrawer");
        const closeProfileDrawerBtn = document.getElementById("closeProfileDrawerBtn");
        const userEmailOrPhone = document.getElementById("userEmailOrPhone");
      
        const loginView = document.getElementById('login-view');
        const otpView = document.getElementById('otp-view');
        const emailLoginView = document.getElementById('email-login-view');
        const signupView = document.getElementById('signup-view');
        const drawerTitle = document.getElementById('drawer-title');
        const allViews = [loginView, otpView, emailLoginView, signupView];
        const loginPrompt = document.getElementById("login-prompt-message");
      
        // --- DRAWER AND VIEW MANAGEMENT ---
        function hideAllViews() { allViews.forEach(view => view?.classList.add('hidden')); }
        window.showLoginView = function() { hideAllViews(); loginView?.classList.remove('hidden'); if(drawerTitle) drawerTitle.textContent = 'Login'; }
        window.showOtpView = function() { hideAllViews(); otpView?.classList.remove('hidden'); if(drawerTitle) drawerTitle.textContent = 'Enter OTP'; }
        window.showEmailLoginView = function() { hideAllViews(); emailLoginView?.classList.remove('hidden'); if(drawerTitle) drawerTitle.textContent = 'Login with Email'; }
        window.showSignupView = function() { hideAllViews(); signupView?.classList.remove('hidden'); if(drawerTitle) drawerTitle.textContent = 'Sign Up'; }
      
        function openProfileDrawer() { profileDrawer?.classList.remove("translate-x-full"); loginOverlay?.classList.remove("hidden"); }
        function closeProfileDrawer() { profileDrawer?.classList.add("translate-x-full"); loginOverlay?.classList.add("hidden"); }
        function hideLoginDrawer() { loginDrawer?.classList.add("translate-x-full"); loginOverlay?.classList.add("hidden"); loginPrompt?.classList.add("hidden"); }
      
        // --- EVENT LISTENERS ---
        loginOpenBtn?.addEventListener("click", () => {
            if (auth.currentUser) { openProfileDrawer(); } 
            else { loginDrawer?.classList.remove("translate-x-full"); loginOverlay?.classList.remove("hidden"); showLoginView(); }
        });
      
        loginCloseBtn?.addEventListener("click", hideLoginDrawer);
        loginOverlay?.addEventListener("click", () => { hideLoginDrawer(); closeProfileDrawer(); });
        closeProfileDrawerBtn?.addEventListener("click", closeProfileDrawer);
        document.getElementById('logout-btn')?.addEventListener('click', () => signOut(auth).then(() => window.location.reload()));
      
        // --- FIREBASE AUTH STATE & FUNCTIONS ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                hideLoginDrawer();
                if (userEmailOrPhone) userEmailOrPhone.textContent = `Welcome! ${user.email || user.phoneNumber}`;
            } else {
                closeProfileDrawer();
            }
        });
        
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });
        let confirmationResultGlobal;
        
        window.sendOTP = async function () {
            const mobile = document.getElementById("phone-number").value;
            if (!/^\d{10}$/.test(mobile)) { alert("Please enter a valid 10-digit mobile number."); return; }
            const fullNumber = "+91" + mobile;
            document.getElementById('otp-phone-display').textContent = fullNumber;
            try {
                confirmationResultGlobal = await signInWithPhoneNumber(auth, fullNumber, window.recaptchaVerifier);
                alert("OTP sent!");
                showOtpView();
            } catch (error) { alert("Failed to send OTP. Error: " + error.message); }
        }
      
        window.verifyOTP = async function () {
            const code = document.getElementById("otp-code").value;
            if (!code) { alert("Please enter the OTP."); return; }
            try {
                await confirmationResultGlobal.confirm(code);
                alert("Login Successful!");
                hideLoginDrawer();
            } catch (error) { alert("Invalid OTP. Please try again."); }
        }
      
        window.signupEmail = async function () {
            const email = document.getElementById("signup-email").value;
            const password = document.getElementById("signup-password").value;
            if (!document.getElementById("terms-agree").checked) { alert("You must agree to the policies."); return; }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert("Signup successful!");
                hideLoginDrawer();
            } catch (error) { alert(error.message); }
        }
      
        window.loginEmail = async function () {
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                alert("Welcome back!");
                hideLoginDrawer();
            } catch (error) { alert("Login failed: " + error.message); }
        }
      
        window.signInWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                alert('Successfully signed in with Google!');
                hideLoginDrawer();
            } catch (error) { alert('Google Sign-In Failed: ' + error.message); }
        }
    </script>
</head>
<body class="bg-beige-50">

    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex-shrink-0 flex items-center"><img class="h-8 w-8" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/ca16fe26-4451-4733-934f-54964f6860ed.png" alt="Grameen Taste logo"><span class="ml-2 text-xl font-bold text-black">Grameen Taste</span></a>
                    <div class="hidden md:ml-8 md:flex md:space-x-8">
                        <a href="index.html#home" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Home</a>
                        <a href="index.html#about" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">About</a>
                        <a href="index.html#products" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Products</a>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <a href="index.html#cart-items" id="cart-btn" class="relative text-gray-500 hover:text-gray-700 p-2"><i class="fas fa-shopping-cart text-xl"></i><span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-6 flex items-center justify-center">0</span></a>
                    <div class="hidden md:block relative"><button id="user-btn" class="text-gray-500 hover:text-gray-700 p-2"><i class="fas fa-user-circle text-xl"></i></button></div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto mt-8 p-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8">
            <div class="image-gallery-container">
                <div class="main-image-container relative mb-4 border rounded-lg overflow-hidden">
                    <img id="main-product-image" src="" alt="Main product image" class="w-full h-auto object-cover">
                    <div id="magnifier-lens" class="magnifier-lens"></div>
                </div>
                <div id="magnified-result" class="magnified-result"></div>

                <div id="thumbnail-list" class="thumbnail-list flex justify-center space-x-2"></div>
            </div>
            
            <div class="product-details-content flex flex-col">
                <h1 id="product-name" class="text-3xl font-bold text-gray-800 mb-2"></h1>
                <div class="flex items-center mb-4"><div class="flex text-yellow-400"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i></div><a href="#reviews" class="ml-3 text-sm text-gray-600 hover:underline">(125 Reviews)</a></div>
                <p id="product-price" class="text-4xl font-light text-green-700 mb-6"></p>
                <p id="product-description" class="text-gray-600 mb-6 leading-relaxed"></p>
                <div class="mb-6"><h3 class="font-semibold text-lg text-gray-700 mb-2">Highlights:</h3><ul id="product-highlights" class="list-disc list-inside text-gray-600 space-y-1"></ul></div>
                <div class="flex flex-col space-y-3 mt-auto">
                    <div id="product-controls-details" class="flex items-center space-x-4"></div>
                    <button id="buy-now-btn" class="w-full bg-yellow-500 text-black px-8 py-3 rounded-md font-bold text-lg hover:bg-yellow-600 transition shadow-lg">
                        <i class="fas fa-bolt mr-2"></i>Buy Now
                    </button>
                </div>
            </div>
        </div>
        <div class="mt-20"><h2 class="text-2xl font-bold text-center text-gray-800 mb-8">You May Also Like</h2><div id="related-products" class="scroll-container flex overflow-x-auto space-x-6 pb-4"></div></div>
    </main>

    <footer class="bg-white py-6 mt-12"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center"><p class="text-gray-600">Â© 2025 Grameen Taste. All rights reserved.</p></div></footer>
    
    <div id="login-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[998] hidden"></div>
    <div id="login-drawer" class="fixed top-0 right-0 w-96 max-w-full h-full bg-white shadow-lg z-[999] transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex justify-between items-center px-4 py-3 border-b"><h3 id="drawer-title" class="text-xl font-semibold">Login</h3><button id="close-login-drawer" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
        <div id="login-prompt-message" class="hidden p-4 m-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-r-lg">
            <p class="font-bold">Authentication Required</p><p class="text-sm">Please log in or create an account to continue.</p>
        </div>
        <div class="p-6 pt-2">
            <div id="recaptcha-container"></div>
            <div id="login-view">
                <div class="relative mb-4"><span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600 border-r pr-3">ðŸ‡®ðŸ‡³ +91</span><input type="tel" id="phone-number" placeholder="Phone" class="w-full pl-[75px] pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"></div>
                <button onclick="sendOTP()" class="w-full bg-green-600 hover:opacity-90 text-white py-3 px-4 rounded font-semibold text-base">Send One Time Password</button>
                <div class="my-4 flex items-center"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-500 text-sm">or</span><div class="flex-grow border-t border-gray-300"></div></div>
                <button onclick="showEmailLoginView()" class="w-full mb-4 flex items-center justify-center border border-gray-300 text-gray-700 py-2 px-4 rounded font-semibold hover:bg-gray-50"><i class="fas fa-envelope mr-2"></i> Continue with Email</button>
                <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center border border-gray-300 text-gray-700 py-2 px-4 rounded font-semibold hover:bg-gray-50"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="h-5 w-5 mr-2" alt="Google icon"> Continue with Google</button>
                <p class="mt-6 text-center text-sm">New to Grameen Taste? <a href="#" onclick="event.preventDefault(); showSignupView();" class="font-semibold text-green-800 hover:underline">Create account</a></p>
            </div>
            <div id="otp-view" class="hidden">
                <p class="text-center mb-4">Enter the OTP sent to <span id="otp-phone-display" class="font-bold"></span></p><input type="text" id="otp-code" placeholder="Enter OTP" class="w-full text-center tracking-[0.5em] px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
                <button onclick="verifyOTP()" class="mt-4 w-full bg-green-600 hover:opacity-90 text-white py-3 px-4 rounded font-semibold">Verify & Login</button><p class="mt-4 text-center text-sm"><a href="#" onclick="event.preventDefault(); showLoginView();" class="font-semibold text-green-800 hover:underline">Go Back</a></p>
            </div>
            <div id="email-login-view" class="hidden">
                <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" required></div>
                <div class="mb-4"><label for="login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" required></div>
                <button onclick="loginEmail()" class="w-full bg-green-600 hover:opacity-90 text-white py-3 px-4 rounded font-semibold">Login</button><p class="mt-4 text-center text-sm"><a href="#" onclick="event.preventDefault(); showLoginView();" class="font-semibold text-[var(--primary)] hover:underline">Other login options</a></p>
            </div>
            <div id="signup-view" class="hidden">
                <div class="mb-4"><label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="signup-email" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" required></div>
                <div class="mb-4"><label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="signup-password" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" required></div>
                <div class="flex items-start mb-4"><input id="terms-agree" type="checkbox" class="h-4 w-4 text-[var(--primary)] focus:ring-[var(--primary)] border-gray-300 rounded mt-1"><label for="terms-agree" class="ml-2 text-sm text-gray-600">I agree to Grameen Taste's policies</label></div>
                <button onclick="signupEmail()" class="w-full bg-green-600 hover:opacity-90 text-white py-3 px-4 rounded font-semibold">Create account</button>
                <p class="mt-6 text-center text-sm">Already have an account? <a href="#" onclick="event.preventDefault(); showLoginView();" class="font-semibold text-green-800 hover:underline">Login</a></p>
            </div>
        </div>
    </div>
    <div id="profileDrawer" class="fixed top-0 right-0 w-full max-w-sm h-full bg-white shadow-lg z-[999] transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex justify-between items-center px-4 py-3 border-b"><h2 class="text-xl font-semibold">My Account</h2><button id="closeProfileDrawerBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
        <div class="p-6"><p id="userEmailOrPhone" class="text-gray-800 font-medium mb-4">Welcome!</p><button id="logout-btn" class="text-red-600 font-semibold hover:underline">Logout</button></div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const productsData = {
            "1": { name: "Traditional Pickles Collection", price: 450, description: "Rediscover the authentic taste of tradition with our set of 3 artisanal pickles. Handmade with love, using sun-dried ingredients and generations-old recipes, each jar is a trip down memory lane.", images: ["https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/645d4130-76bb-40ef-9b3d-6c162cbe1157.png", "https://images.pexels.com/photos/8969237/pexels-photo-8969237.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1", "https://images.pexels.com/photos/6065666/pexels-photo-6065666.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"], highlights: [ "100% Natural Ingredients", "Authentic Village Recipe", "No Artificial Preservatives", "Includes Mango, Lemon, & Mixed Veg" ], related: ["2", "4", "6", "5"]},
            "2": { name: "Handmade Papad Assortment", price: 350, description: "Experience the crispy, crunchy delight of our handmade papads. A versatile assortment of Urad, Moong, and Rice papads, perfect as an appetizer or accompaniment to any Indian meal.", images: ["https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e19db699-3471-4fd8-aa6b-5edcc43a9382.png", "https://images.pexels.com/photos/9059129/pexels-photo-9059129.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"], highlights: [ "Made with Premium Lentil Flour", "Sun-dried to Perfection", "No Artificial Flavors", "Pack of 50 Assorted Papads" ], related: ["1", "3", "4", "5"]},
            "3": { name: "Organic Forest Honey", price: 650, description: "Sourced from the pristine forests of the Himalayas, our organic honey is raw, unfiltered, and bursting with natural goodness. Its rich flavor and aroma make it a perfect natural sweetener.", images: ["https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/b60aa9d1-55da-4e14-b1c8-8f346774fb29.png", "https://images.pexels.com/photos/2642631/pexels-photo-2642631.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"], highlights: [ "100% Raw & Unfiltered", "Rich in Natural Antioxidants", "Sustainably Harvested", "Boosts Immunity & Wellness" ], related: ["6", "1", "4", "2"]},
            "4": { name: "Artisan Spice Blends", price: 550, description: "Unlock the secrets of Indian cuisine with our artisan spice blends. This collection features five essential masalas, freshly ground to preserve their potent aroma and flavor.", images: ["https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/cd50ce92-13ae-46ed-91b5-2c4c879d0f83.png", "https://images.pexels.com/photos/3338497/pexels-photo-3338497.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"], highlights: [ "Authentic Regional Flavors", "Freshly Ground Spices", "No Fillers or Additives", "Includes Garam Masala & More" ], related: ["1", "6", "2", "5"]},
            "5": { name: "Festival Sweet Box", price: 750, description: "Celebrate any occasion with our exquisite Festival Sweet Box. A curated selection of traditional Indian mithai, made with pure ghee and the finest ingredients for an unforgettable taste.", images: ["https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/7238fc74-2fee-4e9d-aa46-09cffeb4fda4.png", "https://images.pexels.com/photos/1070850/pexels-photo-1070850.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"], highlights: [ "Made with Pure Ghee", "Assortment of 8 sweets", "Perfect for Gifting", "Freshly Prepared" ], related: ["3", "1", "6", "4"]},
            "6": { name: "Ayurvedic Beverage Mixes", price: 400, description: "Nourish your body and soul with our Ayurvedic beverage mixes. Based on ancient wellness principles, these blends are crafted to promote balance and vitality with every sip.", images: ["https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/1ea54bee-4c03-4dac-951a-10d358857532.png", "https://images.pexels.com/photos/6157037/pexels-photo-6157037.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"], highlights: [ "Promotes Wellness", "Caffeine-Free Options", "Easy to Prepare", "Includes Turmeric Latte & Herbal Chai" ], related: ["3", "4", "1", "2"]}
        };

        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        const buyNowBtn = document.getElementById('buy-now-btn');

        function updateCartUI(productId) {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById("cart-count").innerText = totalItems;
            updateProductControls(productId);
        }

        function updateProductControls(productId) {
            const controlsContainer = document.getElementById('product-controls-details');
            if (!controlsContainer) return;
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem && cartItem.quantity > 0) {
                 controlsContainer.innerHTML = `<p class="font-semibold text-lg text-gray-700">Quantity:</p><div class="flex items-center gap-3 border rounded-md p-2 bg-white"><button data-id="${productId}" class="decrease-qty text-xl font-bold text-gray-600 hover:text-red-500 w-8 h-8 rounded-full bg-gray-100">-</button><span class="text-xl font-semibold w-10 text-center">${cartItem.quantity}</span><button data-id="${productId}" class="increase-qty text-xl font-bold text-gray-600 hover:text-green-500 w-8 h-8 rounded-full bg-gray-100">+</button></div>`;
            } else {
                controlsContainer.innerHTML = `<button data-id="${productId}" class="add-to-cart w-full bg-green-600 text-white px-8 py-3 rounded-md font-semibold hover:bg-green-700 transition"><i class="fas fa-cart-plus mr-2"></i>Add to Cart</button>`;
            }
            controlsContainer.querySelector('.add-to-cart')?.addEventListener('click', handleCartAction);
            controlsContainer.querySelector('.increase-qty')?.addEventListener('click', handleCartAction);
            controlsContainer.querySelector('.decrease-qty')?.addEventListener('click', handleCartAction);
        }

        function handleCartAction(e) {
            const productId = e.target.dataset.id;
            const productData = productsData[productId];
            let cartItem = cart.find(item => item.id === productId);
            if (e.target.classList.contains('add-to-cart')) {
                cart.push({ id: productId, name: productData.name, price: productData.price, quantity: 1, image: productData.images[0] });
            } else if (e.target.classList.contains('increase-qty') && cartItem) {
                cartItem.quantity++;
            } else if (e.target.classList.contains('decrease-qty') && cartItem) {
                cartItem.quantity--;
                if (cartItem.quantity <= 0) cart = cart.filter(item => item.id !== productId);
            }
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartUI(productId);
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id') || "1";
        const product = productsData[productId];

        if (product) {
            document.title = `${product.name} - Grameen Taste`;
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-price').textContent = `â‚¹${product.price}`;
            document.getElementById('product-description').textContent = product.description;
            const mainImage = document.getElementById('main-product-image');
            
            // Set the initial image source and call the magnifier function
            mainImage.onload = () => {
                imageZoom("main-product-image", "magnified-result", "magnifier-lens");
            };
            mainImage.src = product.images[0];
             // If image is cached, it might not fire onload, so call it manually.
            if (mainImage.complete) {
                mainImage.onload();
            }

            const thumbnailList = document.getElementById('thumbnail-list');
            thumbnailList.innerHTML = product.images.map((imgSrc, i) => `<img src="${imgSrc}" alt="Thumbnail ${i+1}" class="w-20 h-20 object-cover rounded-md cursor-pointer transition-all duration-200 ${i === 0 ? 'active-thumbnail' : ''}">`).join('');
            document.getElementById('product-highlights').innerHTML = product.highlights.map(h => `<li>${h}</li>`).join('');
            document.getElementById('related-products').innerHTML = product.related.map(id => {
                const p = productsData[id];
                return `<div class="flex-none w-64"><div class="bg-white rounded-lg shadow-md overflow-hidden product-card transition duration-300"><a href="product-details.html?id=${id}"><img src="${p.images[0]}" alt="${p.name}" class="w-full h-48 object-cover"></a><div class="p-4"><h3 class="font-bold text-lg mb-2">${p.name}</h3><div class="flex justify-between items-center"><span class="font-bold text-md">â‚¹${p.price}</span><a href="product-details.html?id=${id}" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm font-semibold">View</a></div></div></div></div>`;
            }).join('');
            
            updateCartUI(productId);

            thumbnailList.querySelectorAll('img').forEach(thumb => {
                thumb.addEventListener('click', function() {
                    mainImage.src = this.src;
                    thumbnailList.querySelector('img.active-thumbnail')?.classList.remove('active-thumbnail');
                    this.classList.add('active-thumbnail');
                });
            });

            buyNowBtn?.addEventListener('click', () => {
                if (window.auth && window.auth.currentUser) {
                    const otherItemsInCart = cart.filter(item => item.id !== productId);
                    let proceed = true;

                    if (otherItemsInCart.length > 0) {
                        proceed = confirm("You are using 'Buy Now'. Only this item will be placed in this order. Your other cart items will be saved for later. Do you want to proceed?");
                    }

                    if (proceed) {
                        const product = productsData[productId];
                        if (!product) return;

                        const cartItem = cart.find(item => item.id === productId);
                        const quantity = (cartItem && cartItem.quantity > 0) ? cartItem.quantity : 1;

                        const buyNowCart = [{
                            id: productId,
                            name: product.name,
                            price: product.price,
                            quantity: quantity,
                            image: product.images[0]
                        }];
                        
                        localStorage.setItem('buyNowCart', JSON.stringify(buyNowCart));
                        window.location.href = 'checkout.html';
                    }
                } else {
                    document.getElementById('login-prompt-message')?.classList.remove('hidden');
                    document.getElementById('user-btn')?.click();
                }
            });
            
            // --- CORRECTED IMAGE MAGNIFIER LOGIC ---
            function imageZoom(imgID, resultID, lensID) {
                const img = document.getElementById(imgID);
                const result = document.getElementById(resultID);
                const lens = document.getElementById(lensID);
                const container = img.parentElement;
                let cx, cy;

                container.addEventListener("mouseenter", () => {
                    lens.style.display = "block";
                    result.style.display = "block";

                    result.style.backgroundImage = `url('${img.src}')`;
                    
                    cx = result.offsetWidth / lens.offsetWidth;
                    cy = result.offsetHeight / lens.offsetHeight;

                    result.style.backgroundSize = `${img.width * cx}px ${img.height * cy}px`;
                });

                container.addEventListener("mouseleave", () => {
                    lens.style.display = "none";
                    result.style.display = "none";
                });

                container.addEventListener("mousemove", (e) => {
                    if (lens.style.display !== "block") return;
                    
                    const rect = img.getBoundingClientRect();
                    let x = e.clientX - rect.left;
                    let y = e.clientY - rect.top;

                    let lensX = x - (lens.offsetWidth / 2);
                    let lensY = y - (lens.offsetHeight / 2);

                    if (lensX < 0) lensX = 0;
                    if (lensY < 0) lensY = 0;
                    if (lensX > img.clientWidth - lens.offsetWidth) {
                        lensX = img.clientWidth - lens.offsetWidth;
                    }
                    if (lensY > img.clientHeight - lens.offsetHeight) {
                        lensY = img.clientHeight - lens.offsetHeight;
                    }

                    lens.style.left = `${lensX}px`;
                    lens.style.top = `${lensY}px`;

                    result.style.backgroundPosition = `-${lensX * cx}px -${lensY * cy}px`;
                });
            }

        } else {
            document.querySelector('main').innerHTML = '<p class="text-center text-red-500 text-xl">Sorry, Product Not Found.</p>';
        }
    });
    </script>
</body>
</html>